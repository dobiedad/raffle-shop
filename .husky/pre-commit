#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

RED='\033[0;31m'
NC='\033[0m'

# Get only the files staged for commit
staged_files=$(git diff --cached --name-only --diff-filter=ACM | grep '\.rb$') || true

if [ -z "$staged_files" ]; then
  exit 0
fi

# Run Rubocop auto-correct only on those files
bundle exec rubocop -A --force-exclusion $staged_files

# Re-add only those files (Rubocop may have modified them)
git add $staged_files

# Re-run Rubocop (non-autocorrect) to confirm no violations remain
if bundle exec rubocop --force-exclusion $staged_files; then
  exit 0
else
  echo -e "${RED}Commit has failed, please fix remaining Rubocop errors and try again${NC}"
  exit 1
fi
